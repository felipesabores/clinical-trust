name: Clinical Trust CD

on:
  workflow_run:
    workflows: ["Clinical Trust CI"]
    types:
      - completed
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: ${{ (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') || (github.event_name == 'push') }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Trigger Dokploy Webhook para Docker Compose
      - name: Trigger Dokploy Compose Deploy
        if: env.DOKPLOY_COMPOSE_WEBHOOK_URL != ''
        env:
          DOKPLOY_COMPOSE_WEBHOOK_URL: ${{ secrets.DOKPLOY_COMPOSE_WEBHOOK_URL }}
          DOKPLOY_BRANCH: ${{ secrets.DOKPLOY_BRANCH }}
        run: |
          BRANCH="${DOKPLOY_BRANCH:-main}"
          echo "Triggering Dokploy deploy for branch: $BRANCH"
          curl -s -o /tmp/dokploy_response.txt -w "%{http_code}" -X POST "${DOKPLOY_COMPOSE_WEBHOOK_URL}?branch=${BRANCH}" > /tmp/http_code.txt
          echo "HTTP code: $(cat /tmp/http_code.txt)"
          echo "Response: $(cat /tmp/dokploy_response.txt)"
          test "$(cat /tmp/http_code.txt)" -ge 200 -a "$(cat /tmp/http_code.txt)" -lt 300

      # Example: Deploy via SSH
      # - name: Deploy via SSH
      #   uses: appleboy/ssh-action@master
      #   with:
      #     host: ${{ secrets.SERVER_IP }}
      #     username: ${{ secrets.REMOTE_USER }}
      #     key: ${{ secrets.SSH_PRIVATE_KEY }}
      #     script: |
      #       cd /path/to/project
      #       git pull origin main
      #       cd backend && npm install && npx prisma migrate deploy && npm run build && pm2 restart all
      #       cd ../frontend && npm install && npm run build
